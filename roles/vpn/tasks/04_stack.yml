---
- name: Check for local backup
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/backup/vpn/x-ui/x-ui.db"
  delegate_to: localhost
  become: false
  register: local_backup

- name: Restore x-ui database if backup exists
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/backup/vpn/x-ui/x-ui.db"
    dest: "{{ vpn_path }}/x-ui/x-ui.db"
    mode: "0644"
  when: local_backup.stat.exists
  notify: Restart xui

- name: Display backup restore status
  ansible.builtin.debug:
    msg: "{{ 'Restored backup from ./backup/vpn/' if local_backup.stat.exists else 'No backup found, starting fresh' }}"

- name: Start VPN containers
  community.docker.docker_compose_v2:
    project_src: "{{ vpn_path }}"
    state: present
  register: compose_output

- name: Display access information
  ansible.builtin.debug:
    msg: "VPN Panel: https://{{ domain }}:{{ https_port }}"
