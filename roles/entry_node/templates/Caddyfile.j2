# Caddy configuration for XHTTP reverse proxy
# Domain: {{ node_subdomain }}.{{ cloudflare_zone }}
# Caddy terminates TLS and forwards to Xray via h2c (HTTP/2 cleartext)

{
    # HTTP port for ACME challenges
    http_port 80
    # HTTPS port for XHTTP traffic
    https_port 443
    # Disable HTTP/3 (QUIC) â€” often blocked in RU
    servers {
        protocols h1 h2
    }
}

# XHTTP reverse proxy - Caddy terminates TLS, forwards to Xray via h2c
{{ node_subdomain }}.{{ cloudflare_zone }}:443 {
    # Forward /x* requests to Xray XHTTP inbound via HTTP/2 cleartext
    @xhttp path /x*
    handle @xhttp {
        reverse_proxy h2c://127.0.0.1:{{ entry_node_xhttp_internal_port }} {
            # Low-latency: flush immediately, don't buffer (XHTTP is streaming)
            flush_interval -1
        }
    }

    # Fallback for non-XHTTP requests (camouflage)
    handle {
        respond "Site under construction" 200
    }
}

# Fallback endpoint for Xray REALITY
:{{ entry_node_xhttp_fallback_port }} {
    respond "Site under construction" 200
}
